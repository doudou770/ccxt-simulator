name: Cleanup Old Packages

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨ 2:00 UTC (åŒ—äº¬æ—¶é—´ 10:00) è¿è¡Œ
    # å¦‚éœ€è°ƒæ•´ä¸ºåŒ—äº¬æ—¶é—´å‡Œæ™¨ï¼Œå¯æ”¹ä¸º 'cron: 0 18 * * *' (UTC 18:00 = åŒ—äº¬ 02:00)
    - cron: '0 18 * * *'
  workflow_dispatch:
    inputs:
      keep_versions:
        description: 'ä¿ç•™çš„ç‰ˆæœ¬æ•°é‡'
        required: false
        default: '3'
        type: string
      dry_run:
        description: 'ä»…é¢„è§ˆä¸åˆ é™¤ (true/false)'
        required: false
        default: 'false'
        type: string

env:
  PACKAGE_NAME: ccxt-simulator

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set cleanup parameters
        id: params
        run: |
          # é»˜è®¤ä¿ç•™æœ€è¿‘ 5 ä¸ªç‰ˆæœ¬
          KEEP_VERSIONS="${{ github.event.inputs.keep_versions || '5' }}"
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
          
          echo "KEEP_VERSIONS=${KEEP_VERSIONS}" >> $GITHUB_OUTPUT
          echo "DRY_RUN=${DRY_RUN}" >> $GITHUB_OUTPUT
          echo "ä¿ç•™ç‰ˆæœ¬æ•°: ${KEEP_VERSIONS}"
          echo "é¢„è§ˆæ¨¡å¼: ${DRY_RUN}"

      - name: Delete old package versions
        uses: actions/delete-package-versions@v5
        with:
          package-name: ${{ env.PACKAGE_NAME }}
          package-type: 'container'
          min-versions-to-keep: ${{ steps.params.outputs.KEEP_VERSIONS }}
          delete-only-untagged-versions: 'false'
          # å¿½ç•¥ä»¥ä¸‹æ ‡ç­¾çš„ç‰ˆæœ¬ï¼ˆä¸ä¼šè¢«åˆ é™¤ï¼‰
          ignore-versions: '^(latest|v\d+\.\d+\.\d+)$'

      - name: Cleanup untagged versions
        uses: actions/delete-package-versions@v5
        with:
          package-name: ${{ env.PACKAGE_NAME }}
          package-type: 'container'
          delete-only-untagged-versions: 'true'
          min-versions-to-keep: 0

      - name: Generate cleanup summary
        run: |
          echo "## ðŸ§¹ Package Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Package**: ${{ env.PACKAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¿ç•™ç‰ˆæœ¬æ•°**: ${{ steps.params.outputs.KEEP_VERSIONS }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è¿è¡Œæ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æ¸…ç†å®Œæˆï¼æ—§ç‰ˆæœ¬å’Œæœªæ ‡è®°çš„é•œåƒå·²è¢«åˆ é™¤ã€‚" >> $GITHUB_STEP_SUMMARY
